<!DOCTYPE html>
<meta charset='utf-8'/>
<html>
  <head>
    <title>werm</title>
<style>

html {
  height: 100%;
}
body {
  position: absolute;
  height: 100%;
  width: 100%;
  overflow: hidden;
  margin: 0px;
  padding: 0px;
}
</style>

  </head>
  <body>
    <div id="terminal"
         style="position:relative; width:100%; height:100%"></div>
    <script src="hterm_all.js"></script>
    <script>
var t, sock, sock_ready = false, ready, io, pend_display = '', pend_send = '',
	term_ready = false;

function term_init()
{
	function signal(s)
	{
		var to_send = [], c, ci;

		if (!sock_ready) {
			pend_send += s;
			return;
		}
		s = pend_send + s;
		pend_send = '';

		for (ci = 0; ci < s.length; ci++) {
			c = s.charAt(ci);
			if (c === '\\') to_send.push('\\\\');
			else if (c === '\n') to_send.push('\\n');
			else to_send.push(c);
		}

		to_send = to_send.join('');

		sock.send(to_send);
	}

	sock = new WebSocket('ws://localhost:8090');
	sock.onopen = function()
	{
		sock_ready = true;

		if (!pend_send) return;

		signal(pend_send);
		pend_send = '';
	};

	function display(s)
	{
		if (!term_ready) {
			pend_display += s;
			return;
		}

		var next_esc;
		while (true) {
			next_esc = s.indexOf('\\');
			if (next_esc === -1) next_esc = s.length;
			if (next_esc > 0) {
				t.io.print(s.substr(0, next_esc));
				s = s.substr(next_esc);
			}

			if (!s) break;

			if (s.length === 1) {
				// Escape \ at end of message, send it later.
				pend_display = s;
				break;
			}

			if (s.charAt(1) === 'n') t.io.print('\n');
			else if (s.charAt(1) === '\\') t.io.print('\\');
			else t.io.print(s.charAt(1));

			s = s.substr(2);
		}
	};
	sock.onmessage = function(e) { display(e.data); };

	t = new hterm.Terminal();

	t.onTerminalReady = function()
	{
		io = t.io.push();

		io.sendString = signal;
		io.onVTKeystroke = signal;
		io.onTerminalResize = function(c, r) {
			console.log("io.onTerminalResize: " + c + '.' + r);
		};

		if (pend_display) {
			signal(pend_display);
			pend_display = '';
		}
		term_ready = true;
	};

	t.decorate(document.querySelector('#terminal'));
	t.installKeyboard();
}

window.onload = function()
{
	lib.init().then(term_init);
};
    </script>
  </body>
</html>
