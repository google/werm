#!/bin/sh

cat <<EOF
Content-type: text/html


<!DOCTYPE html>
<meta charset='utf-8'/>
<meta http-equiv="expires" content="-1" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<html>
<head>
	<title>Attach</title>
<style>
td.loose {
	padding-right:20pt;
}
h1 {
	margin-top:0;
	margin-bottom:8pt;
	padding-bottom:8pt;
	border-bottom: solid 1px yellow;
}
.column {
	padding-top: 6pt;
	padding-left: 24pt;
	padding-right: 24pt;
	border: 2px solid yellow;
}
.common-list {
	margin-top: 1em;
	padding-left: 0;
	list-style-type: none;
}
a {
	color: white;
	font-size: 14px;
}
</style>
</head>
<body style="font-family: monospace; font-size: 14px;  background-color: black; color: #8f8;">
<div style="display: flex;">
<div class=column>
<h1>Common</h1>
EOF

for p in ~/.config/werm/profiles/*
do
	echo '<ul class=common-list>'
	sed '
s,\([^	]*\)	\(.*\),<li><a href="/?termid=\1\&pream=\2%0d">\1</a>,
:r
/\( [^ ]*\) /{
	s//\1%20/
	br
}
:s
/\(&[^&]*\)&/{
	s//\1%26/
	bs
}
:t
/\(?[^?]*\)?/{
	s//\1%3f/
	bt
}
	' "$p"
	echo '</ul>'
done

cat <<EOF

</div>
<div class=column>
<h1>Active sessions</h1>
<table>
EOF

lsof -Fn /tmp/dtach.* |
awk '
/^n/ {
	sub(/^n\/tmp\/dtach[.]/, "");
	count[$1] += 1;
}
END {
	for (k in count)
		printf "%s %d\n", k, count[k];
}' |
sort |
while read sess cnt
do
	att='&nbsp;'
	test $cnt = 1 || att='*'
	printf '<tr>
		<td class="loose">[<strong>%s</strong>]
		<td>%s
		<td><a style='font-size:14px' class='restore-link' href="/?termid=%s">%s</a>
		</tr>\n' \
		$sess \
		"$att" \
		$sess \
		$sess
done

cat <<EOF
</table>

<script>
console.log('prep document onload');
window.onload = function() {
console.log('document onload');
var es, title, pream, i;

es = document.getElementsByClassName('restore-link');

for (i = 0; i < es.length; i++) {
	title = localStorage.getItem('title-' + es[i].innerText);
	pream = localStorage.getItem('pream-' + es[i].innerText);
	if (title) es[i].innerText = title;
	if (pream) es[i].href += '&pream=' + encodeURIComponent(pream);
}
};
</script>
</div>
</div>
</body>
</html>
EOF
