#!/bin/sh

cmd_scratch=/tmp/compile_commands_$$.json

cd `dirname $0`
echo '{' >| compile_commands.json

oops () {
	set -x
	: 'required Debian pkgs:'
	: '    libwslay-dev nettle-dev clang pkg-config websocketd dtach'
	exit 1
}

build () {
	mod="$1"
	libs="$2"
	clang -x c -std=c99 -MJ $cmd_scratch -o $mod $mod.c $libs ||
		oops
	cat $cmd_scratch >> compile_commands.json
	rm $cmd_scratch
}

build termserv "`pkg-config --libs nettle`  -lwslay"
build session

echo '}' >> compile_commands.json

echo 'running session test...' >&2
./session test >|/tmp/testout.$$

if ! diff -u passing_test_output /tmp/testout.$$
then
	echo "build succeeded but tests failed; to update:
	cp /tmp/testout.$$ passing_test_output"
	exit 1
fi >&2
