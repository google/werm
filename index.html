<!DOCTYPE html>
<meta charset='utf-8'/>
<html>
  <head>
    <title>werm</title>
<style>

html {
  height: 100%;
}
body {
  position: absolute;
  height: 100%;
  width: 100%;
  overflow: hidden;
  margin: 0px;
  padding: 0px;
}
</style>

  </head>
  <body>
    <div id="terminal"
         style="position:relative; width:100%; height:100%"></div>
    <script src="hterm_all.js"></script>
    <script>
var t, sock, ready, io, pending = '', term_ready = false;

function term_init()
{
	sock = new WebSocket('ws://localhost:8090');
	sock.onconnect = function()
	{
		t = new hterm.Terminal();

		function signal(s)
		{
			s = s.replaceAll('\\', '\\\\').replaceAll('\n', '\\n');
			sock.send(s + '\n');
		}

		t.onTerminalReady = function()
		{
			io = t.io.push();
			console.log("onTerminalReady");
			io.sendString = signal;
			io.onTerminalResize = function(c, r) {
				console.log("io.onTerminalResize: " + c + '.' + r);
			};
			io.onVTKeystroke = function(s) {
				signal(s);
				console.log("keystroke: " + JSON.stringify(s));
			};
			setTimeout(function() {
				console.log("printing terminal data");
				t.io.print('this is ');
				t.io.println('terminal data');
			},
			2000);

			if (pending) {
				t.io.print(pending);
				pending = '';
			}
			term_ready = true;
		};

		t.decorate(document.querySelector('#terminal'));
		t.installKeyboard();
	};
	sock.onmessage = function(e)
	{
		// var s = e.data.replaceAll('\\\\', '\\').replaceAll('\\n', '\n');
		if (!term_ready)
			pending += e.data;
		else
			t.io.print(e.data);
	};
}

window.onload = function() {
  lib.init().then( function() { term_init(); } );
};
    </script>
  </body>
</html>
