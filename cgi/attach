#!/bin/sh

cat <<EOF
Content-type: text/html


<!DOCTYPE html>
<meta charset='utf-8'/>
<html>
<head>
	<title>Attach</title>
<style>
td.loose {
	padding-right:20pt;
}
h1 {
	margin-top:20pt;
	margin-bottom:0;
	font-size:12pt;
}
</style>
</head>
<body style="font-family: monospace">
<h1>Common</h1>
<ul>
EOF

test -f ~/gum/attach_common && ~/gum/attach_common

cat <<EOF
</ul>

<table>
EOF

termno=1
for dir in werm `sort ~/gum/attach_dirs 2>/dev/null`
do
	printf '<tr>'

	termpref=`echo $dir | sed 's/^\///; s/\//-/g'`

	for i in `seq 5`; do
		termid=$termpref-$i
		printf '
		<td class="loose"><a href="/?termid=%s&pream=export%%20LC_TITLEPREF=;exec%%20ow%%20%s%%0d"> [%d]</a href>
		' $termid $dir $i
	done

	printf '<td>%s</tr>' $dir
done

cat <<EOF

</table>
<h1>Active sessions</h1>
<table>
EOF

ls /tmp/dtach.* | sed 's/^[^.]*[.]//' |
while read sess
do
	printf '<tr>
		<td class="loose">[<strong>%s</strong>]
		<td><a class='restore-link' href="/?termid=%s">%s</a>
		</tr>\n' \
		$sess \
		$sess \
		$sess
done

cat <<EOF
</table>

<script>
console.log('prep document onload');
window.onload = function() {
console.log('document onload');
var es, title, i;

es = document.getElementsByClassName('restore-link');

for (i = 0; i < es.length; i++) {
	title = localStorage.getItem('title-' + es[i].innerText);
	if (title) es[i].innerText = title;
}
};
</script>
</body>
</html>
EOF
