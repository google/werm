#!/bin/sh
# Copyright 2023 Google Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

cat <<EOF
Content-type: text/html


<!DOCTYPE html>
<meta charset='utf-8'/>
<meta http-equiv="expires" content="-1" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<html>
<head>
	<title>attach[$SERVER_PORT]</title>
<style>
td.loose {
	padding-right:20pt;
}
h1 {
	margin-top: 7pt;
	margin-bottom:8pt;
	padding-bottom:8pt;
	border-bottom: solid 1px yellow;
}
.column {
	padding-top: 6pt;
	padding-bottom: 6pt;
	padding-left: 24pt;
	padding-right: 24pt;
	border: 2px solid yellow;
}
.common-list {
	margin-top: 1em;
	padding-left: 0;
	list-style-type: none;
}
a {
	color: white;
	font-size: 14px;
	text-decoration: none;
}
a.scratch-link {
	text-decoration: none;
	margin-left: 7pt;
	font-size:12pt;
}
</style>
</head>
<body style="font-family: monospace; font-size: 14px;  background-color: black; color: #8f8;">
<table style="border: 2px solid yellow; border-collapse: collapse">
<tr>
<td class=column style="vertical-align: middle">
<h1 style="border: 0px; padding: 0; margin: 0">scratch</h1>
<td style="padding: 7pt">
<div style="padding-bottom: 7pt">
<a href=/?termid=A class=scratch-link>{A}</a>
<a href=/?termid=B class=scratch-link>{B}</a>
<a href=/?termid=C class=scratch-link>{C}</a>
<a href=/?termid=D class=scratch-link>{D}</a>
<a href=/?termid=E class=scratch-link>{E}</a>
<a href=/?termid=F class=scratch-link>{F}</a>
<a href=/?termid=G class=scratch-link>{G}</a>
<a href=/?termid=H class=scratch-link>{H}</a>
<a href=/?termid=I class=scratch-link>{I}</a>
<a href=/?termid=J class=scratch-link>{J}</a>
<a href=/?termid=K class=scratch-link>{K}</a>
<a href=/?termid=L class=scratch-link>{L}</a>
<a href=/?termid=M class=scratch-link>{M}</a>
</div>
<div>
<a href=/?termid=N class=scratch-link>{N}</a>
<a href=/?termid=O class=scratch-link>{O}</a>
<a href=/?termid=P class=scratch-link>{P}</a>
<a href=/?termid=Q class=scratch-link>{Q}</a>
<a href=/?termid=R class=scratch-link>{R}</a>
<a href=/?termid=S class=scratch-link>{S}</a>
<a href=/?termid=T class=scratch-link>{T}</a>
<a href=/?termid=U class=scratch-link>{U}</a>
<a href=/?termid=V class=scratch-link>{V}</a>
<a href=/?termid=W class=scratch-link>{W}</a>
<a href=/?termid=X class=scratch-link>{X}</a>
<a href=/?termid=Y class=scratch-link>{Y}</a>
<a href=/?termid=Z class=scratch-link>{Z}</a>
</div>
</tr>

<tr>
<td class=column style="vertical-align:top">
<h1>Common</h1>
EOF

# werm repo subdir should have profiles to use
for p in $WERMDIR/profiles/* $HOME/.config/werm/profiles/*
do
	echo '<ul class=common-list>'
	sed '
s_\([^	]*\)	\([^	]*\)\(	\(.*\)\)\{0,1\}_<li><a href="/?js=\4\&termid=\1\&pream=\2%0d">\1</a>_
:r
/\( [^ ]*\) /{
	s//\1%20/
	br
}
:s
/\(pream=.*\)&/{
	s//\1%26/
	bs
}
:t
/\(?[^?]*\)?/{
	s//\1%3f/
	bt
}
	' "$p"
	echo '</ul>'
done

cat <<EOF

<td class=column style="vertical-align: top">
<h1>Active sessions</h1>
<table>
EOF

lsof -Fn $WERMDIR/var/dtach.* |
awk '
/^n/ && !/\/var\/dtach[.]ephem[.]/ {
	sub(/^n.*\/var\/dtach[.]/, "");
	count[$1] += 1;
}
END {
	for (k in count)
		printf "%s %d\n", k, count[k];
}' |
# Sort according to ASCII - this puts ~ at the end of the list.
LC_ALL=C sort |
while read sess cnt
do
	att='&nbsp;'
	test $cnt = 1 || att='*'
	printf '<tr>
		<td class="loose">[<strong>%s</strong>]
		<td>%s
		<td><a style='font-size:14px' class='restore-link' href="/?termid=%s">%s</a>
		</tr>\n' \
		$sess \
		"$att" \
		$sess \
		$sess
done

cat <<EOF
</table>
</tr>
</table>

<script>
console.log('prep document onload');
window.onload = function() {
console.log('document onload');
var es, title, pream, i, auxjs, int;

es = document.getElementsByClassName('restore-link');

for (i = 0; i < es.length; i++) {
	int = es[i].innerText;
	title = (localStorage.getItem('title-' + int) || '').trim();
	pream = localStorage.getItem('pream-' + int);
	auxjs = localStorage.getItem('js-' + int);
	if (title) es[i].innerText = title;
	if (pream) es[i].href += '&pream=' + encodeURIComponent(pream);
	if (auxjs) es[i].href += '&js=' + encodeURIComponent(auxjs);
}
};
</script>
</body>
</html>
EOF
