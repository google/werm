<!DOCTYPE html>
<meta charset='utf-8'/>
<html>
  <head>
    <title>werm</title>
<style>

@font-face {
  font-family: jfdot;
  src: url(font.ttf);
}

html {
  height: 100%;
}
body {
  position: absolute;
  height: 100%;
  width: 100%;
  overflow: hidden;
  margin: 0px;
  padding: 0px;
}
</style>

  </head>
  <body>
    <div id="terminal"
         style="position:relative; width:100%; height:100%"></div>
    <script src="hterm_all.js"></script>
    <script>
var t, sock, sock_ready = false, ready, io, pend_display = '', pend_send = '',
	term_ready = false;

function term_init()
{
	function signal(s)
	{
		if (!sock_ready) {
			pend_send += s;
		}
		else {
			sock.send(pend_send + s);
			pend_send = '';
		}
	}

	sock = new WebSocket('ws://' + location.host + '/' + location.search);
	sock.onopen = function()
	{
		sock_ready = true;

		if (!pend_send) return;

		sock.send(pend_send);
		pend_send = '';
	};

	function display(s)
	{
		var next_esc;

		function hex_val(i)
		{
			var c = s.charAt(i);
			if (c >= '0' && c <= '9') return s.charCodeAt(i) - 48;
			if (c >= 'a' && c <= 'f') return s.charCodeAt(i) - 87;
			throw `invalid hex at ${i} in ${s}: ${c}`
		}

		if (!term_ready) {
			pend_display += s;
			return;
		}

		s = pend_display + s;
		pend_display = '';

		while (true) {
			next_esc = s.indexOf('\\');
			if (next_esc === -1) next_esc = s.length;
			if (next_esc > 0) {
				t.io.print(s.substr(0, next_esc));
				s = s.substr(next_esc);
			}

			if (!s) break;

			if (s.length < 3) {
				// Escape is incomplete, so send it later.
				pend_display = s;
				break;
			}

			t.io.print(
				String.fromCharCode(hex_val(1) * 16 +
						    hex_val(2)));

			s = s.substr(3);
		}
	};
	sock.onmessage = function(e) { display(e.data); };

	t = new hterm.Terminal();

	function escape(s)
	{
		var e = [], c, ci;

		for (ci = 0; ci < s.length; ci++) {
			c = s.charAt(ci);
			if (c === '\\') e.push('\\\\');
			else if (c === '\n') e.push('\\n');
			else e.push(c);
		}

		return e.join('');
	}

	t.onTerminalReady = function()
	{
		io = t.io.push();

		io.sendString = function(s) { signal(escape(s)); };
		io.onVTKeystroke = function(s) { signal(escape(s)); };
		io.onTerminalResize = function(c, r) {
			signal('\\w' + (10000 + r + '').substr(1)
				     + (10000 + c + '').substr(1));
		};

		term_ready = true;
		display('');
	};

	t.decorate(document.querySelector('#terminal'));
	t.installKeyboard();
}

window.onload = function()
{
	lib.init().then(term_init);
};
    </script>
  </body>
</html>
